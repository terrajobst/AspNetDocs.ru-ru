---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: Учебник. Использование миграций EF в приложении ASP.NET MVC и развертывание в Azure
author: tdykstra
description: В этом руководстве описано, как включить миграцию Code First и развернуть приложение в облаке в Azure.
ms.author: riande
ms.date: 01/16/2019
ms.topic: tutorial
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 989dd0f0e18b338be057b9c5657586eff996d8ea
ms.sourcegitcommit: b95316530fa51087d6c400ff91814fe37e73f7e8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/23/2019
ms.locfileid: "70000770"
---
# <a name="tutorial-use-ef-migrations-in-an-aspnet-mvc-app-and-deploy-to-azure"></a>Учебник. Использование миграций EF в приложении ASP.NET MVC и развертывание в Azure

До сих пор пример веб-приложения Contoso университета работает локально в IIS Express на компьютере разработчика. Чтобы обеспечить доступ к реальному приложению для других пользователей через Интернет, необходимо развернуть его для поставщика услуг размещения веб-сайтов. В этом руководстве описано, как включить миграцию Code First и развернуть приложение в облаке в Azure.

- Включите Code First Migrations. Функция миграции позволяет изменять модель данных и развертывать изменения в рабочей среде путем обновления схемы базы данных без необходимости удаления и повторного создания базы данных.
- Выполните развертывание в Azure. Этот шаг является необязательным. Вы можете продолжить работу с остальными учебниками без развертывания проекта.

Рекомендуется использовать процесс непрерывной интеграции с системой управления версиями для развертывания, но в этом учебнике эти темы не рассматриваются. Дополнительные сведения см. в разделах [Управление исходным кодом](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) и [Непрерывная интеграция](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) [Создание облачных приложений в реальном мире с помощью Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction).

В этом учебнике рассмотрены следующие задачи.

> [!div class="checklist"]
> * Включение миграции Code First
> * Развертывание приложения в Azure (необязательно)

## <a name="prerequisites"></a>Предварительные требования

- [Устойчивость подключений и перехват команд](connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application.md)

## <a name="enable-code-first-migrations"></a>Включение миграции Code First

При разработке нового приложения ваша модель данных часто меняется, и при каждом таком изменении она нарушает синхронизацию с базой данных. Вы настроили Entity Framework для автоматического удаления и повторного создания базы данных каждый раз при изменении модели данных. При каждом добавлении, удалении или изменении классов сущностей или изменении `DbContext` класса при следующем запуске приложения он автоматически удаляет существующую базу данных, создает новую, которая соответствует модели, и заполняет ее данными теста.

Этот способ для обеспечения синхронизации базы данных с моделью данных хорошо работает до развертывания приложения в рабочей среде. Когда приложение выполняется в рабочей среде, обычно сохраняются данные, которые необходимо сохранить, и вы не хотите потерять все при каждом внесении изменений, например при добавлении нового столбца. Функция [Code First migrations](https://msdn.microsoft.com/data/jj591621) решает эту проблему, позволяя Code First обновлять схему базы данных вместо удаления и повторного создания базы данных. В этом руководстве вы развернете приложение и подготовите его к работе, чтобы включить миграцию.

1. Отключите инициализатор, который вы настроили ранее, закомментируйте или удалив `contexts` элемент, добавленный в файл Web. config приложения.

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. Кроме того, в файле *Web. config* приложения измените имя базы данных в строке подключения на ContosoUniversity2.

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    Это изменение настраивает проект таким образом, чтобы первая миграция создавала новую базу данных. Это не обязательно, но позже вы увидите, почему это хорошая идея.
3. В меню **Сервис** последовательно выберите пункты **Диспетчер пакетов NuGet** > **Консоль диспетчера пакетов**.

1. `PM>` В командной строке введите следующие команды:

    ```text
    enable-migrations
    add-migration InitialCreate
    ```

    Команда создает папку *migrations* в проекте ContosoUniversity и помещает в эту папку файл Configuration.cs, который можно изменить для настройки миграции. `enable-migrations`

    (Если вы пропустили приведенный выше шаг, чтобы изменить имя базы данных, миграция найдет существующую базу данных и автоматически `add-migration` выполнит команду. Это просто означает, что вы не будете выполнять тестирование кода миграции перед развертыванием базы данных. Позже при выполнении `update-database` команды ничего не произойдет, так как база данных уже существует.)

    Откройте файл *контосауниверсити\мигратионс\конфигуратион.КС* . Подобно классу инициализатора, который вы видели ранее `Configuration` , класс `Seed` включает метод.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    Цель метода [начального значения](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) заключается в возможности вставки или обновления тестовых данных после Code First создания или обновления базы данных. Метод вызывается при создании базы данных и при каждом обновлении схемы базы данных после изменения модели данных.

### <a name="set-up-the-seed-method"></a>Настройка метода начального значения

При удалении и повторном создании базы данных для каждого изменения модели данных используется `Seed` метод класса инициализатора для вставки тестовых данных, поскольку после изменения каждой модели база данных удаляется и все проверочные данные теряются. При использовании Code First Migrations тестовые данные сохранены после изменения базы данных, поэтому, как правило, не требуется включать данные тестирования в метод [SEED](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) . На самом деле, не нужно `Seed` , чтобы метод вставил тестовые данные, если вы будете использовать миграции для развертывания базы данных в рабочей среде, `Seed` так как метод будет выполняться в рабочей среде. В этом случае необходимо, `Seed` чтобы метод вставил в базу данных только те данные, которые необходимы в рабочей среде. Например, может потребоваться, чтобы база данных включала фактические имена отделов `Department` в таблицу, когда приложение станет доступным в рабочей среде.

В рамках этого руководства вы будете использовать миграции для развертывания, но ваш `Seed` метод будет в любом случае вставлять тестовые данные, чтобы упростить просмотр работы функций приложения без необходимости вручную вставлять большой объем данных.

1. Замените содержимое файла *Configuration.CS* следующим кодом, который загружает тестовые данные в новую базу данных.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    Метод [SEED](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) принимает объект контекста базы данных в качестве входного параметра, а код в методе использует этот объект для добавления новых сущностей в базу данных. Для каждого типа сущности код создает коллекцию новых сущностей, добавляет их в соответствующее свойство [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) , а затем сохраняет изменения в базе данных. Не нужно вызывать метод [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) после каждой группы сущностей, как это сделано здесь, но это помогает узнать источник проблемы, если исключение возникает во время записи кода в базу данных.

    Некоторые инструкции, которые вставляют данные, используют метод [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) для выполнения операции "Upsert". Поскольку метод выполняется каждый раз при `update-database` выполнении команды, как правило, после каждой миграции данные нельзя просто вставить, так как добавляемые строки уже будут существовать после первой миграции, создающей базу данных. `Seed` Операция "Upsert" предотвращает ошибки, которые могут возникать при попытке вставить уже существующую строку, но ***переопределяет*** любые изменения данных, которые могли быть сделаны при тестировании приложения. При использовании тестовых данных в некоторых таблицах может быть нежелательно: в некоторых случаях при изменении данных во время тестирования необходимо сохранить изменения после обновления базы данных. В этом случае необходимо выполнить операцию условной вставки: вставить строку, если она еще не существует. Метод SEED использует оба подхода.

    Первый параметр, передаваемый методу [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) , указывает свойство, используемое для проверки, существует ли уже строка. Для данных тестового учащегося, которые вы предоставляете, `LastName` свойство можно использовать для этой цели, так как каждое Последнее имя в списке является уникальным:

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    В этом коде предполагается, что последние имена являются уникальными. Если вы вручную добавите учащийся с дубликатом фамилии, вы получите следующее исключение при следующем выполнении миграции:

    **Последовательность содержит более одного элемента**

    Дополнительные сведения об обработке избыточных данных, таких как два учащихся с именем "Александр Carson", см. в разделе [Заполнение и отладка Entity Framework (EF) баз данных](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) в блоге Рик Андерсон (. Дополнительные сведения о `AddOrUpdate` методе см. в разделе [использование метода AddOrUpdate EF 4,3](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) в блоге Юлия Лерман.

    Код, создающий `Enrollment` сущности, предполагает, что `ID` у вас есть значение `students` в сущностях в коллекции, хотя это свойство не было задано в коде, который создает коллекцию.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    Здесь можно использовать свойство `ID` , `ID` так как значение задается `students` при вызове `SaveChanges` для коллекции. EF автоматически получает значение первичного ключа при вставке сущности в базу данных и обновляет `ID` свойство сущности в памяти.

    Код, который добавляет каждую `Enrollment` сущность `Enrollments` в набор `AddOrUpdate` сущностей, не использует метод. Он проверяет, существует ли сущность, и вставляет сущность, если она не существует. Этот подход позволит сохранить изменения, внесенные в уровень регистрации, с помощью пользовательского интерфейса приложения. Код проходит по каждому элементу `Enrollment` [списка](https://msdn.microsoft.com/library/6sh2ey19.aspx) , и если регистрация не найдена в базе данных, она добавляет регистрацию в базу данных. При первом обновлении базы данных она будет пустой, поэтому она добавит каждую регистрацию.

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]

2. Выполните построение проекта.

### <a name="execute-the-first-migration"></a>Выполнение первой миграции

При выполнении `add-migration` команды выполняется миграция кода, который создал бы базу данных с нуля. Этот код также находится в папке *migrations* в файле с именем  *&lt;timestamp&gt;\_InitialCreate.CS*. Метод класса создает таблицы базы данных, соответствующие наборам `Down` сущностей модели данных, и метод удаляет их. `InitialCreate` `Up`

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

Функция миграций вызывает метод `Up`, чтобы реализовать изменения модели данных для миграции. При вводе команды для отката обновления функция миграций вызывает метод `Down`.

Это первоначальный перенос, созданный при вводе `add-migration InitialCreate` команды. Параметр (`InitialCreate` в примере) используется для имени файла и может быть любым. обычно вы выбираете слово или фразу, которая суммирует данные, выполняемые при миграции. Например, вы можете присвоить имя более &quot;позднему AddDepartmentTable&quot;миграции.

Если вы создали первоначальную миграцию, когда база данных уже существовала, код для создания базы данных формируется, но выполнять его не требуется, так как база данных уже соответствует модели данных. Однако при развертывании приложения в другой среде, где база данных еще не существует, этот код будет выполняться для создания базы данных, поэтому рекомендуется сначала его протестировать. Вот почему вы изменили имя базы данных в строке подключения ранее&mdash;, чтобы миграция могла создать новую с нуля.

1. В окне **консоли диспетчера пакетов** введите следующую команду:

    `update-database`

    Команда запускает метод для создания базы данных `Seed` , а затем запускает метод для заполнения базы данных. `Up` `update-database` Этот процесс будет выполняться автоматически в рабочей среде после развертывания приложения, как показано в следующем разделе.
2. Используйте **Обозреватель сервера** , чтобы проверить базу данных, как в первом руководстве, и запустить приложение, чтобы убедиться, что все по-прежнему работает так же, как и раньше.

## <a name="deploy-to-azure"></a>Развертывание в Azure

Пока приложение запущено локально в IIS Express на компьютере разработчика. Чтобы сделать его доступным для других пользователей через Интернет, необходимо развернуть его для поставщика услуг размещения веб-сайтов. В этом разделе руководства вы развернете его в Azure. Этот раздел является необязательным. Вы можете пропустить это и продолжить выполнение приведенного ниже руководства. Кроме того, вы можете адаптировать инструкции в этом разделе для другого поставщика услуг размещения по своему усмотрению.

### <a name="use-code-first-migrations-to-deploy-the-database"></a>Использование Code First миграций для развертывания базы данных

Чтобы развернуть базу данных, используйте Code First Migrations. При создании профиля публикации, который используется для настройки параметров развертывания из Visual Studio, необходимо установить флажок **обновить базу данных**. Этот параметр приводит к тому, что процесс развертывания автоматически настраивает файл *Web. config* приложения на целевом сервере, чтобы Code First `MigrateDatabaseToLatestVersion` использует класс инициализатора.

Visual Studio не выполняет никаких действий с базой данных во время процесса развертывания, пока выполняется копирование проекта на целевой сервер. При запуске развернутого приложения и доступе к базе данных в первый раз после развертывания Code First проверяет, соответствует ли база данных модели данных. В случае несоответствия Code First автоматически создает базу данных (если она еще не существует) или обновляет схему базы данных до последней версии (если база данных существует, но не соответствует модели). Если приложение реализует `Seed` метод миграции, метод выполняется после создания базы данных или обновления схемы.

`Seed` Метод миграции вставляет тестовые данные. При развертывании в рабочей среде необходимо изменить `Seed` метод так, чтобы он вставил только те данные, которые необходимо вставить в рабочую базу данных. Например, в текущей модели данных может возникнуть необходимость в реальных курсах, но вымышленных учащихся в базе данных разработки. Можно написать `Seed` метод для загрузки в процессе разработки, а затем закомментировать вымышленные учащиеся перед развертыванием в рабочей среде. Кроме того, можно написать `Seed` метод для загрузки только курсов и ввести вымышленные учащиеся в тестовой базе данных вручную с помощью пользовательского интерфейса приложения.

### <a name="get-an-azure-account"></a>Получение учетной записи Azure

Вам потребуется учетная запись Azure. Если у вас ее еще нет, но у вас есть подписка Visual Studio, вы можете [активировать преимущества](https://azure.microsoft.com/pricing/member-offers/credit-for-visual-studio-subscribers/
)подписки. В противном случае можно создать бесплатную пробную учетную запись всего за несколько минут. Дополнительные сведения см. в статье [Бесплатная пробная версия Azure](https://azure.microsoft.com/free/).

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a>Создание веб-сайта и базы данных SQL в Azure

Ваше веб-приложение в Azure будет работать в общей среде размещения. Это означает, что она выполняется на виртуальных машинах, которые являются общими для других клиентов Azure. Общая среда размещения — это экономичный способ начать работу в облаке. Позже, если веб-трафик увеличится, приложение сможет масштабироваться в соответствии с потребностями, запуская на выделенных виртуальных машинах. Дополнительные сведения о ценах на службу приложений Azure см. в статье [цены на службу приложений](https://azure.microsoft.com/pricing/details/app-service/).

Вы развернете базу данных в базе данных SQL Azure. База данных SQL — это облачная служба реляционной базы данных, построенная на основе технологий SQL Server. Средства и приложения, работающие с SQL Server также работают с базой данных SQL.

1. В [портал управления Azure](https://portal.azure.com)выберите **создать ресурс** на левой вкладке, а затем выберите **Просмотреть все** в **новой** панели (или в *колонке*), чтобы просмотреть все доступные ресурсы. Выберите **веб-приложение + SQL** в разделе **веб** в колонке **все** . Наконец, выберите **создать**.

    ![Создание ресурса в портал Azure](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/create-azure-resource.png)

   Откроется форма для создания нового **нового ресурса веб-приложения + SQL** .

2. Введите строку в поле **имя приложения** , чтобы использовать его в качестве уникального URL-адреса для приложения. Полный URL-адрес будет содержать то, что вы вводите здесь, а также домен по умолчанию служб приложений Azure (. azurewebsites.net). Если **имя приложения** уже занято, мастер выводит сообщение с красным *названием приложение недоступно* . Если **имя приложения** доступно, отображается зеленая галочка.

3. В поле **Подписка** выберите подписку Azure, в которой должна находиться **служба приложений** .

4. В текстовом поле **Группа ресурсов** выберите группу ресурсов или создайте новую. Этот параметр указывает центр обработки данных, в котором будет выполняться веб-сайт. Дополнительные сведения о группах ресурсов см. в разделе [группы ресурсов](/azure/azure-resource-manager/resource-group-overview#resource-groups).

5. Создайте новый **план службы приложений** , щелкнув *раздел служба приложений*, **создавайте новые**и заполните **план службы приложений** (это может быть то же имя, что и служба приложений), **Расположение**и **ценовая** Категория (бесплатный вариант).

6. Щелкните **база данных SQL**, а затем выберите **создать новую базу** данных или выбрать существующую.

7. В поле **имя** введите имя базы данных.
8. Щелкните поле **целевой сервер** , а затем выберите **создать новый сервер**. Кроме того, если ранее был создан сервер, можно выбрать этот сервер из списка доступных серверов.
9. Выберите **категорию ценовая** Категория и щелкните *Free (бесплатный*). Если требуются дополнительные ресурсы, базу данных можно масштабировать в любое время. Дополнительные сведения о ценах на SQL Azure см. на странице [цен на базу данных SQL Azure](https://azure.microsoft.com/pricing/details/sql-database/managed/).
10. При необходимости измените [Параметры сортировки](/sql/relational-databases/collations/collation-and-unicode-support) .
11. Введите **имя пользователя администратора SQL** и **пароль администратора SQL**.

    - Если выбран **новый сервер базы данных SQL**, определите новое имя и пароль, которые будут использоваться позже при доступе к базе данных.
    - Если вы выбрали ранее созданный сервер, введите учетные данные для этого сервера.

12. Сбор данных телеметрии можно включить для службы приложений с помощью Application Insights. При небольшом объеме настройки Application Insights собирает ценные сведения о событиях, исключениях, зависимостях, запросах и трассировках. Дополнительные сведения о Application Insights см. в разделе [Azure Monitor](https://azure.microsoft.com/services/monitor/).
13. Щелкните **создать** внизу, чтобы указать, что все готово.

    Портал управления возвращается на страницу панели мониторинга, а область **уведомлений** в верхней части страницы показывает, что сайт создается. Через некоторое время (обычно меньше минуты) имеется уведомление о том, что развертывание прошло. На панели навигации слева в разделе **службы приложений** появится новая служба приложений, а в разделе **базы данных SQL** появится новая база данных SQL.

### <a name="deploy-the-app-to-azure"></a>Развертывание приложения в Azure

1. В Visual Studio щелкните правой кнопкой мыши проект в **Обозреватель решений** и выберите в контекстном меню пункт **опубликовать** .

2. На странице **Выбор целевого объекта публикации** выберите **служба приложений** , а затем щелкните **существующие**и нажмите кнопку **опубликовать**.

    ![Выбор целевой страницы публикации](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/publish-select-existing-azure-app-service.png)

3. Если вы ранее не добавили подписку Azure в Visual Studio, выполните действия на экране. Эти действия позволяют Visual Studio подключиться к подписке Azure, чтобы список **служб приложений** включал ваш веб-сайт.

4. На странице **служба приложений** выберите **подписку** , в которую вы добавили службу приложений. В разделе **вид**выберите **Группа ресурсов**. Разверните группу ресурсов, в которую вы добавили службу приложений, а затем выберите службу приложений. Нажмите кнопку **ОК** , чтобы опубликовать приложение.

5. В окне **вывод** отображаются действия по развертыванию, которые были выполнены, и сообщает об успешном завершении развертывания.

6. После успешного развертывания браузер по умолчанию автоматически открывается по URL-адресу развернутого сайта.

    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/cloud-app-browser.png)

    Теперь приложение выполняется в облаке.

На этом этапе база данных *SchoolContext* была создана в базе данных SQL Azure, так как вы выбрали **Execute Code First migrations (выполняется при запуске приложения)** . Файл *Web. config* на развернутом веб-сайте был изменен таким образом, чтобы инициализатор [мигратедатабасетолатестверсион](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) выполнялся в первый раз, когда код считывает или записывает данные в базе данных (что произошло, если выбрана вкладка **учащихся** ). ):

![Фрагмент файла Web. config](https://asp.net/media/4367421/mig.png)

В процессе развертывания также создается новая строка подключения *\_(SchoolContext датабасепублиш*) для Code First migrations, используемая для обновления схемы базы данных и заполнения базы данных.

![Строка подключения в файле Web. config](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

Развернутая версия файла Web. config можно найти на компьютере в *контосауниверсити\обж\релеасе\паккаже\паккажетмп\веб.конфиг*. Доступ к развернутому файлу *Web. config* можно получить с помощью протокола FTP. Инструкции см. в [разделе ASP.NET Web Deployment in Visual Studio: Развертывание обновления](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update)кода. Следуйте инструкциям, которые начинаются с "для использования средства FTP, требуются три вещи: URL-адрес FTP, имя пользователя и пароль".

> [!NOTE]
> Веб-приложение не реализует безопасность, поэтому любой пользователь, который найдет URL-адрес, может изменить данные. Инструкции по обеспечению безопасности веб-сайта см. в статье [развертывание безопасного приложения ASP.NET MVC с членством, OAuth и база данных SQL в Azure](/aspnet/core/security/authorization/secure-data). Вы можете запретить другим пользователям использовать сайт, останавливая службу с помощью портал управления или **Обозреватель сервера** в Visual Studio.

![Пункт меню "закрыть службу приложений"](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/server-explorer-stop-app-service.png)

## <a name="advanced-migrations-scenarios"></a>Сценарии расширенной миграции

При развертывании базы данных с автоматическим запуском миграций, как показано в этом руководстве, и при развертывании на веб-сайт, работающий на нескольких серверах, можно получить несколько серверов, пытающихся одновременно запустить миграцию. Миграции являются атомарными, поэтому если два сервера пытаются выполнить одну и ту же миграцию, одна из них будет успешно выполнена, а другая завершится неудачей (при условии, что операции не могут быть выполнены дважды). В этом случае, если вы хотите избежать этих проблем, можно вызвать миграции вручную и настроить собственный код так, чтобы он выводился только один раз. Дополнительные сведения см. в статьях [Запуск и создание сценариев миграции из кода](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) в блоге Роуэн Миллер и [Migrate. exe](/ef/ef6/modeling/code-first/migrations/migrate-exe) (для выполнения миграций из командной строки).

Сведения о других сценариях миграции см. в статье [переходы по презентациям](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).

## <a name="update-specific-migration"></a>Обновление конкретной миграции

`update-database -target MigrationName`

`update-database -target MigrationName` Команда запускает целевую миграцию.

## <a name="ignore-migration-changes-to-database"></a>Игнорировать изменения миграции для базы данных

`Add-migration MigrationName -ignoreChanges`

`ignoreChanges`Создает пустую миграцию с текущей моделью в виде моментального снимка.

## <a name="code-first-initializers"></a>Инициализаторы Code First

В разделе Deployment (развертывание) вы видели используемый инициализатор [мигратедатабасетолатестверсион](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) . Code First также предоставляет другие инициализаторы, включая [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (по умолчанию), [дропкреатедатабасеифмоделчанжес](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (который вы использовали ранее) и [дропкреатедатабасеалвайс](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx). `DropCreateAlways` Инициализатор может быть полезен для настройки условий для модульных тестов. Можно также написать собственные инициализаторы, и вы можете вызвать инициализатор явным образом, если вы не хотите ждать, пока приложение не закончит чтение или запись в базу данных.

Дополнительные сведения о инициализаторах см. в разделе Основные сведения об [инициализаторах баз данных в Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) и главе [6 Entity Framework программирования книги: Code First](http://shop.oreilly.com/product/0636920022220.do) от Джулия Лерман и Роуэн Миллер.

## <a name="get-the-code"></a>Получите код

[Скачать завершенный проект](https://webpifeed.blob.core.windows.net/webpifeed/Partners/ASP.NET%20MVC%20Application%20Using%20Entity%20Framework%20Code%20First.zip)

## <a name="additional-resources"></a>Дополнительные ресурсы

Ссылки на другие ресурсы Entity Framework можно найти в [материалах, рекомендуемых для доступа к данным ASP.NET](xref:whitepapers/aspnet-data-access-content-map).

## <a name="next-steps"></a>Следующие шаги

В этом учебнике рассмотрены следующие задачи.

> [!div class="checklist"]
> * Включенные Code First миграции
> * Развертывание приложения в Azure (необязательно)

Перейдите к следующей статье, чтобы узнать, как создать более сложную модель данных для приложения ASP.NET MVC.
> [!div class="nextstepaction"]
> [Создание более сложной модели данных](creating-a-more-complex-data-model-for-an-asp-net-mvc-application.md)
